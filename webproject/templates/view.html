<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendation</title>
    <style>
        @font-face {
            font-family: 'DungGeunMo';
            src: url('{{ url_for('static', filename='fonts/DungGeunMo.ttf') }}') format('truetype');
        }
        
        body {
            background-color: black;
            margin: 0;
            overflow-x: hidden;
            height: 100vh;
            font-family: 'DungGeunMo', cursive, monospace;
            color: white;
            position: relative;
        }

        .frame-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
        }

        .frame-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .background-overlay {
            background-image: url('{{ url_for('static', filename='homeimg/background.png') }}');
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center;
            background-attachment: fixed;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.2;
            z-index: 0;
        }

        .noticeboard-container {
            position: absolute;
            top: 58%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: auto;
            z-index: 10;
        }

        .noticeboard-img {
            width: 100%;
            height: auto;
            object-fit: contain;
        }

        .home-button {
            position: absolute;
            top: 30px;
            left: 30px;
            width: 130px;
            height: auto;
            cursor: pointer;
            z-index: 1;
            transition: transform 0.2s;
        }
        .home-button:hover {
            transform: scale(1.05);
        }

        .guide-button {
            position: absolute;
            top: 30px;
            left: 180px;
            width: 130px;
            height: auto;
            cursor: pointer;
            z-index: 1;
            transition: transform 0.2s;
        }
        .guide-button:hover {
            transform: scale(1.05);
        }

        .archive-button {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 130px;
            height: auto;
            cursor: pointer;
            z-index: 1;
            transition: transform 0.2s;
        }
        .archive-button:hover {
            transform: scale(1.05);
        }

        .recommendation-card {
            position: relative;
            top: 55%;
            left: 52%;
            transform: translate(-50%, -50%);
            width: 600px;
            height: 250px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            z-index: 20;
        }

        .unified-sound-button {
            position: absolute;
            top: 0px;         /* LP ìƒë‹¨ ì¤‘ì•™ ê¸°ì¤€ ìœ„ì¹˜ */
            left: 90px;        /* LP ì¤‘ì•™ */
            transform: translateX(-50%);
            width: 36px;       /* ì‚´ì§ ì‘ê²Œ */
            height: 36px;
            z-index: 25;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .unified-sound-button:hover {
            transform: translateX(-50%) scale(1.05);
        }

        .image-box {
            width: 180px;
            height: 180px;
            border: 2px solid black;
            margin-right: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .hashtag {
            position: absolute;
            bottom: 7px;
            left: 20px;
            color: #6e0000;
            font-size: 16px;
            font-family: 'DungGeunMo', cursive, monospace;
            z-index: 25;
            white-space: nowrap;
            text-align: left;
            width: 560px;
            overflow: hidden;
        }

        .hashtag.marquee {
            display: inline-flex;
            animation: marquee 8s linear infinite;
        }

        @keyframes marquee {
            0% { transform: translateX(0%); }
            10% { transform: translateX(0%); }
            100% { transform: translateX(-100%); }
        }

        .tag {
            margin-right: 8px;
        }

        .text-box {
            color: black;
            font-family: 'DungGeunMo', cursive, monospace;
            font-size: 20px;
            line-height: 1.8;
            margin-left: 20px;
        }

        .text-box .value {
            color: #6e0000;
            white-space: nowrap;
            display: inline-block;
        }

        .album-title-value {
            display: inline-block;
            max-width: 260px;
            overflow: hidden;
            white-space: nowrap;
            vertical-align: middle;
            position: relative;
        }
        .marquee-inner {
            display: inline-block;
            white-space: nowrap;
            /* width: autoê°€ ê¸°ë³¸! */
            will-change: transform;
        }
        @keyframes marquee-move {
            0%   { transform: translateX(0); }
            100% { transform: translateX(calc(-1 * var(--move-distance, 0px))); }
        }
        .text-box .value.marquee {
            display: inline-flex;
            animation: marquee 6s linear infinite;
        }

        .label {
            color: black;
        }

        .arrow {
            position: absolute;
            top: 58%;
            transform: translateY(-50%);
            width: 50px;
            height: 50px;
            cursor: pointer;
            z-index: 30;
        }

        .left-arrow {
            left: calc(50% - 350px);
        }

        .right-arrow {
            right: calc(50% - 350px);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .lp-container {
            position: relative;
            width: 180px;
            height: 180px;
            transform-origin: center center;
            animation: spin 15s linear infinite;
        }

        .album-img {
            position: absolute;
            top: 25%;
            left: 25%;
            width: 50%;
            height: 50%;
            object-fit: cover;
            z-index: 1;
        }

        .lp-img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
        }

        .slide {
            display: none;
        }
        .slide.active {
            display: flex;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.8);
        }

        .modal-content {
            margin: 10% auto;
            padding: 20px;
            width: 60%;
            font-family: 'DungGeunMo', cursive, monospace;
            color: white;
            line-height: 1.6;
        }

        .modal-content ol {
            padding-left: 20px;
            margin-bottom: 0;
        }

        .modal-content ol > li {
            margin-bottom: 12px;
        }

        .modal-content ul {
            list-style-type: disc;
            padding-left: 20px;
            margin-top: 6px;
        }

        .close-button {
            color: #000;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover {
            color: red;
        }

        .no-result {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: white;
            font-size: 20px;
            z-index: 20;
        }

        /* ë°˜ì‘í˜• ë””ìì¸ */
       @media (max-width: 768px) {
            .noticeboard-container {
                width: 110vw;
                top: 55%;
            }
            .noticeboard-img {
                width: 110vw !important;
                height: 130vw !important;
                object-fit: cover !important;
                display: block;
                margin: 0 auto;
            }
            .recommendation-card {
                width: 80vw !important;
                height: 50vw !important;
                flex-direction: column !important;
                align-items: center !important;
                gap: 10px !important;
                top: 55% !important;
            }
            .lp-container {
                width: 20vw;
                height: 20vw;
                border-radius: 50%;
                overflow: hidden;
                position: relative;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: spin 15s linear infinite;
            }
            .album-img {
                position: absolute;
                top: 50%; left: 50%;
                width: 54%; height: 54%;
                transform: translate(-50%, -50%);
                object-fit: cover;
                border-radius: 50%;
                z-index: 1;
            }
            .lp-img {
                position: absolute;
                top: 0; left: 0;
                width: 100%; height: 100%;
                border-radius: 50%;
                z-index: 2;
                pointer-events: none;
                object-fit: cover;
            }
            .text-box {
                margin-left: 0;
                font-size: 16px;
                width: 76vw;
                text-align: center;
            }
            .hashtag {
                font-size: 14px;
                bottom: 1vw;
                width: 76vw;
                left: 50%;
                transform: translateX(-50%);
                text-align: center;
            }
            .left-arrow {
                left: calc(50% - 45vw);
            }
            .right-arrow {
                right: calc(50% - 45vw);
            }
            .unified-sound-button {
                top: 80%;
                left: 50%;
                transform: translateX(-50%);
                width: 8vw;
            }
            .home-button, .guide-button, .archive-button {
                width: 15vw;
            }
        }

        @media (max-width: 480px) {
            .recommendation-card {
                height: 50vw;
            }
            
            .lp-container {
                width: 40vw;
                height: 40vw;
            }
            
            .text-box {
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="background-overlay"></div>
    
    <div class="frame-container">
        <img src="{{ url_for('static', filename='homeimg/frame.png') }}" alt="í”„ë ˆì„" class="frame-img">
    </div>

    <div class="noticeboard-container">
        <img src="{{ url_for('static', filename='recimg/board.png') }}" alt="ê²Œì‹œíŒ" class="noticeboard-img">
    </div>

    <a href="/home/">
        <img src="{{ url_for('static', filename='recimg/home.png') }}" alt="í™ˆ" class="home-button">
    </a>

    <img src="{{ url_for('static', filename='recimg/guide.png') }}" alt="ê°€ì´ë“œ" class="guide-button" id="guide-button">

    <a href="/archive/">
        <img src="{{ url_for('static', filename='recimg/archive.png') }}" alt="ì•„ì¹´ì´ë¸Œ" class="archive-button">
    </a>
    
    {% if result and result.recommendations %}
        {% for song in result.recommendations %}
            <div class="recommendation-card slide">
                <img src="{{ url_for('static', filename='recimg/soundoff.png') }}" alt="ìŒì•… ì¬ìƒ/ì •ì§€" class="unified-sound-button">
                <div class="lp-container">
                    <img src="{{ result.image_info.web_url }}" alt="ì•¨ë²” ì´ë¯¸ì§€" class="album-img">
                    <img src="{{ url_for('static', filename='recimg/lp.png') }}" alt="LP" class="lp-img">
                </div>
                <div class="text-box">
                    <div class="album-title">
                        <span class="label">ê³¡ëª…:</span>
                        <span class="value album-title-value">
                            <span class="marquee-inner">{{ song['ê³¡ëª…'] }}</span>
                        </span>
                    </div>
                    <div class="artist">
                        <span class="label">ê°€ìˆ˜:</span>
                        <span class="value">{{ song['ê°€ìˆ˜'] }}</span>
                    </div>
                    <div class="genre">
                        <span class="label">ì¥ë¥´:</span>
                        <span class="value">{{ song['ì¥ë¥´'] }}</span>
                    </div>
                    <div class="like">
                        <span class="label">â¤ìœ ì‚¬ë„:</span>
                        <span class="value">{{ "%.1f"|format(song['similarity'] * 100) }}%</span>
                    </div>
                </div>
                <audio class="audio-player" src="{{ song['audio_url'] if song.get('audio_url') else '' }}" preload="none"></audio>
                <div class="hashtag">
                    {% set unique_tags = [] %}
                    {% for key, value in result.tags.items() %}
                        {% if value and value not in unique_tags %}
                            {% set _ = unique_tags.append(value) %}
                            <span class="tag">#{{ value }}</span>
                        {% endif %}
                    {% endfor %}
                    {% for tag_field in ['ìƒí™©íƒœê·¸', 'ê°ì„±íƒœê·¸', 'ìŠ¤íƒ€ì¼íƒœê·¸', 'ê³„ì ˆíƒœê·¸'] %}
                        {% if song[tag_field] and song[tag_field] != "[]" %}
                            {% for tag in song[tag_field]|parse_list %}
                                {% if tag.strip() and tag.strip() not in unique_tags %}
                                    {% set _ = unique_tags.append(tag.strip()) %}
                                    <span class="tag">#{{ tag.strip() }}</span>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="no-result">
            <p>ì•„ì§ ìŒì•… ì¶”ì²œ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p>ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  ì¥ë¥´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>
    {% endif %}

    <img src="{{ url_for('static', filename='recimg/left.png') }}" class="arrow left-arrow" alt="ì´ì „">
    <img src="{{ url_for('static', filename='recimg/right.png') }}" class="arrow right-arrow" alt="ë‹¤ìŒ">

    <div id="guide-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-guide">Ã—</span>
            <h2>ğŸ“– ì‚¬ìš©ì ì•ˆë‚´ì„œ</h2>
            <ol>
                <li>
                    <strong>ì´ {{ result.recommendations|length if result else 5 }}ê³¡ ì¶”ì²œ</strong>
                    <ul>
                        <li>ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¥ë¥´ ê°ê°ì—ì„œ ê°€ì¥ ìœ ì‚¬ë„ê°€ ë†’ì€ ê³¡ì„ 1ê³¡ì”© ì¶”ì²œí•©ë‹ˆë‹¤.</li>
                        <li>ë‚˜ë¨¸ì§€ ê³¡ì€ ì‚¬ìš©ìê°€ ì„ íƒí•œ ì¥ë¥´ ì¤‘ì—ì„œ ìœ ì‚¬ë„ê°€ ë†’ì€ ê³¡ë“¤ ì¤‘ ëœë¤ìœ¼ë¡œ ì„ íƒë©ë‹ˆë‹¤.</li>
                    </ul>
                </li>
                <li>
                    <strong>í•´ì‹œíƒœê·¸ ì•ˆë‚´</strong>
                    <ul>
                        <li>ê° ê³¡ì˜ ì´ë¯¸ì§€ì—ì„œ ì¶”ì¶œí•œ í•´ì‹œíƒœê·¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.</li>
                        <li>ê³¡ì˜ ë¶„ìœ„ê¸°ì™€ íŠ¹ì„±ì„ í•œëˆˆì— íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    </ul>
                </li>
                <li>
                    <strong>ìŒì•… ì¬ìƒ</strong>
                    <ul>
                        <li>
                            <img src="{{ url_for('static', filename='recimg/soundon.png') }}" alt="ì¬ìƒ" style="width:20px; height:20px; vertical-align:middle;">
                            í˜¹ì€
                            <img src="{{ url_for('static', filename='recimg/soundoff.png') }}" alt="ì¼ì‹œì •ì§€" style="width:20px; height:20px; vertical-align:middle;">
                            ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ í˜„ì¬ ê³¡ì„ ì¬ìƒí•˜ê±°ë‚˜ ì¼ì‹œì •ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </li>
                    </ul>
                </li>
                <li>
                    <strong>ê³¡ ë„˜ê¸°ê¸°</strong>
                    <ul>
                        <li>
                            ì¢Œìš°ì— ë°°ì¹˜ëœ
                            <img src="{{ url_for('static', filename='recimg/left.png') }}" alt="ì™¼ìª½" style="width:20px; height:20px; vertical-align:middle;">
                            ì™€
                            <img src="{{ url_for('static', filename='recimg/right.png') }}" alt="ì˜¤ë¥¸ìª½" style="width:20px; height:20px; vertical-align:middle;">
                            ë¥¼ í´ë¦­í•˜ì—¬ ë‹¤ìŒ ê³¡ìœ¼ë¡œ ë„˜ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                        </li>
                    </ul>
                </li>
            </ol>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            let currentSlide = 0;
            const slides = document.querySelectorAll('.slide');
            const leftArrow = document.querySelector('.left-arrow');
            const rightArrow = document.querySelector('.right-arrow');
            let currentAudio = null;
            let isPlaying = false;

            // ìŠ¬ë¼ì´ë“œ ì´ë™ í•¨ìˆ˜
            function changeSlide(direction) {
                pauseCurrentAudio();
                if (direction === 'next') {
                    currentSlide = (currentSlide + 1) % slides.length;
                } else {
                    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                }
                showSlide(currentSlide);
            }

            leftArrow.addEventListener('click', () => changeSlide('prev'));
            rightArrow.addEventListener('click', () => changeSlide('next'));

            // ê°€ì´ë“œ ëª¨ë‹¬ ì´ë²¤íŠ¸
            const guideButton = document.getElementById('guide-button');
            const guideModal = document.getElementById('guide-modal');
            const closeGuide = document.getElementById('close-guide');

            guideButton.addEventListener('click', () => {
                guideModal.style.display = 'block';
            });

            closeGuide.addEventListener('click', () => {
                guideModal.style.display = 'none';
            });

            window.addEventListener('click', (event) => {
                if (event.target == guideModal) {
                    guideModal.style.display = 'none';
                }
            });

            // í˜„ì¬ ì˜¤ë””ì˜¤ ì •ì§€ í•¨ìˆ˜
            function pauseCurrentAudio() {
                if (currentAudio) {
                    currentAudio.pause();
                    currentAudio.currentTime = 0;
                    currentAudio = null;
                }
                isPlaying = false;
                // ëª¨ë“  ì‚¬ìš´ë“œ ë²„íŠ¼ì„ soundoffë¡œ ë³€ê²½
                slides.forEach(slide => {
                    const btn = slide.querySelector('.unified-sound-button');
                    if (btn) {
                        btn.src = "/static/recimg/soundoff.png";
                    }
                });
            }

            // ë§ˆí‚¤ íš¨ê³¼ ì ìš© í•¨ìˆ˜
            function applyMarquee(target, container) {
                // 1. ì´ˆê¸°í™”
                target.classList.remove('marquee');
                const marqueeInner = target.querySelector('.marquee-inner');
                if (marqueeInner) {
                    marqueeInner.style.animation = "none";
                    marqueeInner.offsetWidth; // reflow
                    // ê¸¸ì´ ê³„ì‚°
                    const boxWidth = target.offsetWidth;
                    const textWidth = marqueeInner.scrollWidth;
                    if (textWidth > boxWidth) {
                        // ê¸¸ ë•Œë§Œ ì• ë‹ˆë©”ì´ì…˜
                        const distance = textWidth - boxWidth + 30;
                        const duration = 2 + distance / 40;
                        marqueeInner.style.animation = `marquee-move ${duration}s linear infinite`;
                        marqueeInner.style.setProperty('--move-distance', `${distance}px`);
                    }
                } else if (container) {
                    // ê¸°ì¡´ valueë‚˜ hashtag ë§ˆí‚¤ (í…ìŠ¤íŠ¸ ê¸¸ì´ ê¸°ì¤€)
                    target.classList.remove('marquee');
                    void target.offsetWidth;
                    if (target.scrollWidth > container.clientWidth) {
                        target.classList.add('marquee');
                    }
                }
            }

            function showSlide(index) {
                if (slides.length === 0) return;

                // ëª¨ë“  ìŠ¬ë¼ì´ë“œ ìˆ¨ê¸°ê¸°
                slides.forEach((slide, i) => {
                    slide.classList.toggle('active', i === index);
                });

                // í˜„ì¬ ìŠ¬ë¼ì´ë“œì˜ ì‚¬ìš´ë“œ ë²„íŠ¼ ì´ë²¤íŠ¸ ë°”ì¸ë”©
                const currentSlideElement = slides[index];
                const unifiedSoundButton = currentSlideElement.querySelector('.unified-sound-button');
                const audio = currentSlideElement.querySelector('.audio-player');

                // ëª¨ë“  ì‚¬ìš´ë“œ ë²„íŠ¼ì˜ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                slides.forEach(slide => {
                    const btn = slide.querySelector('.unified-sound-button');
                    if (btn) {
                        btn.replaceWith(btn.cloneNode(true));
                    }
                });

                // í˜„ì¬ ìŠ¬ë¼ì´ë“œì˜ ì‚¬ìš´ë“œ ë²„íŠ¼ì—ë§Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                const newSoundButton = currentSlideElement.querySelector('.unified-sound-button');
                if (newSoundButton) {
                    // ì´ˆê¸° ìƒíƒœë¥¼ soundoffë¡œ ì„¤ì •
                    newSoundButton.src = "/static/recimg/soundoff.png";
                    
                    newSoundButton.addEventListener('click', () => {
                        if (!audio || !audio.src) {
                            alert('í˜„ì¬ ê³¡ì˜ ì˜¤ë””ì˜¤ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }

                        if (!isPlaying) {
                            // ì¬ìƒ ì‹œì‘
                            audio.play().then(() => {
                                isPlaying = true;
                                currentAudio = audio;
                                newSoundButton.src = "/static/recimg/soundon.png";
                            }).catch((error) => {
                                console.error('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨:', error);
                                alert('ì¬ìƒí•  ìˆ˜ ì—†ëŠ” URLì…ë‹ˆë‹¤.');
                            });
                        } else {
                            // ì¬ìƒ ì¤‘ì§€
                            pauseCurrentAudio();
                        }
                    });
                }

                // ì˜¤ë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                if (audio) {
                    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ìƒˆë¡œìš´ audio ìš”ì†Œë¡œ êµì²´
                    const newAudio = audio.cloneNode(true);
                    audio.parentNode.replaceChild(newAudio, audio);
                    
                    newAudio.addEventListener('ended', () => {
                        isPlaying = false;
                        currentAudio = null;
                        if (newSoundButton) {
                            newSoundButton.src = "/static/recimg/soundoff.png";
                        }
                    });

                    newAudio.addEventListener('error', (e) => {
                        console.error('ì˜¤ë””ì˜¤ ë¡œë“œ ì—ëŸ¬:', e);
                        isPlaying = false;
                        currentAudio = null;
                        if (newSoundButton) {
                            newSoundButton.src = "/static/recimg/soundoff.png";
                        }
                    });
                }

                // ë§ˆí‚¤ íš¨ê³¼ ì ìš©
                const albumTitleElement = currentSlideElement.querySelector('.album-title-value');
                if (albumTitleElement) {
                    setTimeout(() => applyMarquee(albumTitleElement), 100);
                }

                const hashtagElement = currentSlideElement.querySelector('.hashtag');
                if (hashtagElement) {
                    setTimeout(() => applyMarquee(hashtagElement, currentSlideElement), 100);
                }
            }

            // ì´ˆê¸° ì„¤ì •
            if (slides.length > 0) {
                showSlide(currentSlide);
            }

            // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸
            window.addEventListener('resize', () => {
                if (slides.length > 0) {
                    showSlide(currentSlide);
                }
            });
        });
    </script>
</body>
</html>